# Release — mirrors GitLab CI: XCFramework, Package-Binary, Binary podspec, INSTALLATION.md, CocoaPods, Release
# Runs on tag v*.*.* or workflow_dispatch (like TEST_RELEASE_PIPELINE).

name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
  LANG: en_US.UTF-8

jobs:
  build-and-test:
    name: Build and test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: swift build -c release
      - run: swift test

  # ---- Archive per platform (same as GitLab .xcframework_build_template) ----
  build-ios-device:
    name: Archive iOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          xcodebuild archive \
            -project SwiftKT.xcodeproj \
            -scheme SwiftKT \
            -destination "generic/platform=iOS" \
            -configuration Release \
            -archivePath "./build/SwiftKT-iphoneos.xcarchive" \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      - uses: actions/upload-artifact@v4
        with:
          name: archive-ios
          path: build/SwiftKT-iphoneos.xcarchive

  build-ios-simulator:
    name: Archive iOS Simulator
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          xcodebuild archive \
            -project SwiftKT.xcodeproj \
            -scheme SwiftKT \
            -destination "generic/platform=iOS Simulator" \
            -configuration Release \
            -archivePath "./build/SwiftKT-iphonesimulator.xcarchive" \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      - uses: actions/upload-artifact@v4
        with:
          name: archive-ios-simulator
          path: build/SwiftKT-iphonesimulator.xcarchive

  build-macos:
    name: Archive macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          xcodebuild archive \
            -project SwiftKT.xcodeproj \
            -scheme SwiftKT \
            -destination "generic/platform=macOS" \
            -configuration Release \
            -archivePath "./build/SwiftKT-macosx.xcarchive" \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      - uses: actions/upload-artifact@v4
        with:
          name: archive-macos
          path: build/SwiftKT-macosx.xcarchive

  # ---- Create XCFramework + same artifacts as GitLab (Package-Binary, Binary podspec, INSTALLATION.md) ----
  create-xcframework:
    name: Create XCFramework
    runs-on: macos-latest
    needs: [build-ios-device, build-ios-simulator, build-macos]
    steps:
      - uses: actions/checkout@v4
      - name: Download archives
        uses: actions/download-artifact@v4
        with:
          path: build
          merge-multiple: true
      - name: Create XCFramework
        run: |
          # Downloaded artifacts: build/archive-ios/, build/archive-ios-simulator/, build/archive-macos/
          # Each contains xcarchive contents: Products/Library/Frameworks/SwiftKT.framework
          IOS_FW="build/archive-ios/Products/Library/Frameworks/SwiftKT.framework"
          IOS_SIM_FW="build/archive-ios-simulator/Products/Library/Frameworks/SwiftKT.framework"
          MAC_FW="build/archive-macos/Products/Library/Frameworks/SwiftKT.framework"
          if [ ! -d "$IOS_FW" ]; then
            IOS_FW="build/SwiftKT-iphoneos.xcarchive/Products/Library/Frameworks/SwiftKT.framework"
            IOS_SIM_FW="build/SwiftKT-iphonesimulator.xcarchive/Products/Library/Frameworks/SwiftKT.framework"
            MAC_FW="build/SwiftKT-macosx.xcarchive/Products/Library/Frameworks/SwiftKT.framework"
          fi
          xcodebuild -create-xcframework \
            -framework "$IOS_FW" \
            -framework "$IOS_SIM_FW" \
            -framework "$MAC_FW" \
            -output build/SwiftKT.xcframework
      - name: Verify XCFramework
        run: find build/SwiftKT.xcframework -type f -name SwiftKT | head -5 | xargs file
      - name: Zip and checksum
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          [ -z "$VERSION" ] && VERSION="0.0.0"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          cd build
          zip -r "SwiftKT-${VERSION}.xcframework.zip" SwiftKT.xcframework
          shasum -a 256 "SwiftKT-${VERSION}.xcframework.zip" > "SwiftKT-${VERSION}.xcframework.zip.sha256"
          CHECKSUM=$(cut -d' ' -f1 "SwiftKT-${VERSION}.xcframework.zip.sha256")
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_ENV
      - name: Create Package-Binary.swift (same as GitLab)
        run: |
          VERSION="${{ env.VERSION }}"
          CHECKSUM="${{ env.CHECKSUM }}"
          REPO="${{ github.server_url }}/${{ github.repository }}"
          TAG="${{ github.ref_name }}"
          cat > build/Package-Binary.swift << EOF
          // swift-tools-version:5.9
          import PackageDescription

          let package = Package(
              name: "SwiftKT",
              platforms: [
                  .iOS(.v16),
                  .macOS(.v13),
                  .tvOS(.v16),
                  .watchOS(.v9),
              ],
              products: [
                  .library(name: "SwiftKT", targets: ["SwiftKT"]),
              ],
              targets: [
                  .binaryTarget(
                      name: "SwiftKT",
                      url: "${REPO}/releases/download/${TAG}/SwiftKT-${VERSION}.xcframework.zip",
                      checksum: "${CHECKSUM}"
                  )
              ]
          )
          EOF
      - name: Create SwiftKT-Binary.podspec (same as GitLab binary podspec)
        run: |
          VERSION="${{ env.VERSION }}"
          CHECKSUM="${{ env.CHECKSUM }}"
          REPO="${{ github.server_url }}/${{ github.repository }}"
          TAG="${{ github.ref_name }}"
          cat > build/SwiftKT-Binary.podspec << EOF
          Pod::Spec.new do |spec|
            spec.name          = 'SwiftKT-Binary'
            spec.version       = '${VERSION}'
            spec.summary       = 'SwiftKT - Binary Distribution'
            spec.description   = 'Pre-compiled XCFramework for SwiftKT'
            spec.homepage      = '${REPO}'
            spec.license       = { :type => 'MIT', :file => 'LICENSE' }
            spec.author        = { 'anahjz' => 'https://github.com/anahjz' }
            spec.source        = {
              :http => '${REPO}/releases/download/${TAG}/SwiftKT-${VERSION}.xcframework.zip',
              :sha256 => '${CHECKSUM}'
            }
            spec.ios.deployment_target = '16.0'
            spec.osx.deployment_target = '13.0'
            spec.tvos.deployment_target = '16.0'
            spec.watchos.deployment_target = '9.0'
            spec.vendored_frameworks = 'SwiftKT.xcframework'
            spec.swift_version = '5.9'
          end
          EOF
      - name: Create INSTALLATION.md (same as GitLab)
        run: |
          VERSION="${{ env.VERSION }}"
          CHECKSUM="${{ env.CHECKSUM }}"
          REPO="${{ github.server_url }}/${{ github.repository }}"
          TAG="${{ github.ref_name }}"
          cat > build/INSTALLATION.md << 'INNER'
          # SwiftKT Binary Distribution

          ## Swift Package Manager (Binary)
          Add to your `Package.swift`:
          ```swift
          dependencies: [
              .package(url: "REPO_PLACEHOLDER.git", from: "VERSION_PLACEHOLDER")
          ]
          ```
          Or use the binary attachment from this release.

          ## CocoaPods (Binary)
          ```ruby
          pod 'SwiftKT-Binary', '~> VERSION_PLACEHOLDER'
          ```

          ## Manual
          1. Download `SwiftKT-VERSION_PLACEHOLDER.xcframework.zip`
          2. Extract and add SwiftKT.xcframework to your project

          ## Verification
          SHA256: CHECKSUM_PLACEHOLDER
          INNER
          sed -i '' "s|REPO_PLACEHOLDER|${REPO}|g; s|VERSION_PLACEHOLDER|${VERSION}|g; s|CHECKSUM_PLACEHOLDER|${CHECKSUM}|g" build/INSTALLATION.md
      - uses: actions/upload-artifact@v4
        with:
          name: xcframework
          path: |
            build/SwiftKT.xcframework
            build/SwiftKT-*.xcframework.zip
            build/SwiftKT-*.xcframework.zip.sha256
            build/Package-Binary.swift
            build/SwiftKT-Binary.podspec
            build/INSTALLATION.md

  # ---- Create GitHub Release (same as GitLab create-release) ----
  create-release:
    name: Create release
    needs: [build-and-test, create-xcframework]
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          name: xcframework
          path: build
      - name: Get version
        id: ver
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          [ -z "$VERSION" ] && VERSION="0.0.0"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Generate release notes (same structure as GitLab)
        run: |
          TAG="${{ steps.ver.outputs.tag }}"
          VERSION="${{ steps.ver.outputs.version }}"
          REPO="${{ github.server_url }}/${{ github.repository }}"
          echo "## Changes since previous release" > release_notes.md
          PREV=$(git describe --tags --abbrev=0 $TAG^ 2>/dev/null || true)
          if [ -n "$PREV" ]; then
            git log --pretty=format:"- %s (%h)" $PREV..$TAG >> release_notes.md
          else
            echo "First release of SwiftKT" >> release_notes.md
          fi
          echo "" >> release_notes.md
          echo "## Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Swift Package Manager" >> release_notes.md
          echo '```swift' >> release_notes.md
          echo ".package(url: \"${REPO}.git\", from: \"${VERSION}\")" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "### XCFramework" >> release_notes.md
          echo "Download the attached \`SwiftKT-${VERSION}.xcframework.zip\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Checksum:** \`$(cut -d' ' -f1 build/SwiftKT-${VERSION}.xcframework.zip.sha256)\`" >> release_notes.md
      - name: Create Release and upload assets (same assets as GitLab)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: SwiftKT ${{ steps.ver.outputs.tag }}
          body_path: release_notes.md
          draft: false
          generate_release_notes: true
          files: |
            build/SwiftKT-*.xcframework.zip
            build/SwiftKT-*.xcframework.zip.sha256
            build/Package-Binary.swift
            build/SwiftKT-Binary.podspec
            build/INSTALLATION.md

  # ---- Publish CocoaPods (same as GitLab: push Binary podspec) ----
  publish-cocoapods:
    name: Publish to CocoaPods
    needs: [create-xcframework]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: xcframework
          path: build
      - name: Install CocoaPods
        run: gem install cocoapods
      - name: Publish SwiftKT-Binary to trunk (same as GitLab)
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          if [ -z "$COCOAPODS_TRUNK_TOKEN" ]; then
            echo "⚠️ COCOAPODS_TRUNK_TOKEN not set - skipping CocoaPods publish"
            exit 0
          fi
          mkdir -p ~/.cocoapods
          echo "$COCOAPODS_TRUNK_TOKEN" > ~/.cocoapods/token
          cd build
          pod trunk push SwiftKT-Binary.podspec --allow-warnings
          echo "✓ Published to CocoaPods successfully!"
    continue-on-error: true

  # ---- Create binary repo (same as GitLab create-binary-repo, optional) ----
  create-binary-repo:
    name: Create binary repo
    needs: [create-xcframework]
    runs-on: ubuntu-latest
    if: false
    steps:
      - name: Skip
        run: |
          echo "Set BINARY_REPO_TOKEN and re-enable this job to push to a separate SwiftKT-binary repo"
          echo "Same logic as GitLab create-binary-repo (git init, Package-Binary.swift, README, push)"
